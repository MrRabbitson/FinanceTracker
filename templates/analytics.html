{% extends "base.html" %}

{% block title %}Аналитика - Финансовый Трекер{% endblock %}

{% block content %}
<h1 class="section-title"><i class="fas fa-chart-bar"></i> Финансовая аналитика</h1>

<div class="analytics-flex" style="display: flex; gap: 2rem; margin-bottom: 3rem;">
    <div class="card" style="flex: 1; min-width: 0;">
        <h3><i class="fas fa-chart-pie"></i> Расходы по категориям</h3>
        <div class="chart-container">
            <canvas id="spendingChart"></canvas>
        </div>
    </div>

    <div class="card" style="flex: 1; min-width: 0;">
        <h3><i class="fas fa-star"></i> Статистика</h3>
        <div style="padding: 1rem 0;">
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-lighter);">Общие расходы:</strong><br>
                <span style="color: var(--primary); font-size: 1.2rem;">{{ "%.2f"|format(spending_by_category.values()|sum if spending_by_category else 0) }} ₽</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-lighter);">Количество категорий:</strong><br>
                <span style="color: var(--primary); font-size: 1.2rem;">{{ spending_by_category|length }}</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-lighter);">Средний расход:</strong><br>
                <span style="color: var(--primary); font-size: 1.2rem;">{{ "%.2f"|format(spending_by_category.values()|sum / spending_by_category|length if spending_by_category else 0) }} ₽</span>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 3rem;">
    <h3><i class="fas fa-robot"></i> Советы от ИИ</h3>
    <div style="padding: 1rem 0;">
        <p id="ai-tips-content">Загрузка советов...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const spendingData = {{ spending_by_category|tojson }};
let spendingChart;

function updateChartTheme(chart, isDark) {
    chart.options.plugins.legend.labels.color = isDark ? '#F3F4F6' : '#333333';
    chart.options.plugins.tooltip.titleColor = isDark ? '#FFFFFF' : '#000000';
    chart.options.plugins.tooltip.bodyColor = isDark ? '#FFFFFF' : '#000000';
    chart.options.plugins.tooltip.backgroundColor = isDark ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)';
    chart.update();
}

if (Object.keys(spendingData).length > 0) {
    const spendingCtx = document.getElementById('spendingChart').getContext('2d');
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    spendingChart = new Chart(spendingCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(spendingData),
            datasets: [{
                data: Object.values(spendingData),
                backgroundColor: [
                    '#8B5CF6', '#36A2EB', '#10B981', '#F59E0B', '#EF4444', '#EC4899'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: isDark ? '#F3F4F6' : '#333333'
                    }
                },
                tooltip: {
                    titleColor: isDark ? '#FFFFFF' : '#000000',
                    bodyColor: isDark ? '#FFFFFF' : '#000000',
                    backgroundColor: isDark ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)'
                }
            }
        }
    });

    window.addEventListener('themeChanged', (event) => {
        const isDark = event.detail.theme === 'dark';
        updateChartTheme(spendingChart, isDark);
    });
} else {
    document.getElementById('spendingChart').parentElement.innerHTML = '<p style="color: rgba(243, 244, 246, 0.7); text-align: center; padding: 2rem;">Нет данных для отображения. Добавьте расходы, чтобы увидеть диаграмму.</p>';
}

document.addEventListener('DOMContentLoaded', function() {
    const tipsDiv = document.getElementById('ai-tips-content');
    tipsDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
    fetch('/get_ai_tips')
    .then(res => res.json())
    .then(data => {
        tipsDiv.innerHTML = data.tips.replace(/\n/g, '<br>');
    })
    .catch(() => {
        tipsDiv.textContent = 'Ошибка загрузки советов.';
    });
});

</script>
{% endblock %}